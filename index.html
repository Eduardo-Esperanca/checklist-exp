<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checklist de Veﾃｭculo - Expediﾃｧﾃ｣o</title>
<style>
  /* Variﾃ｡veis de Cores e Estilos - TEMA AZUL */
  :root{
    --bg:#f8fafc; /* Fundo mais suave */
    --card:#fff;
    --accent:#2563eb; /* Azul profissional */
    --ok:#2563eb; /* Azul para "Sim" */
    --nok:#dc2626; /* Vermelho para "Nﾃ｣o" */
    --na:#6b7280; /* Cinza para "N/A" */
    --text-primary:#1e293b;
    --text-secondary:#475569;
    --border:#e2e8f0;
    --radius:10px;
    --success:#10b981; /* Verde para feedback positivo */
    --warning:#f59e0b; /* Laranja para avisos */
  }
  *{box-sizing:border-box}
  body{
    font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:var(--bg);
    margin:0;
    padding:25px;
    color:var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
  }
  .container{max-width:950px;margin:0 auto}
  h1{
    margin:0 0 20px;
    font-size:28px;
    color:var(--accent);
    border-bottom:3px solid var(--accent);
    padding-bottom:10px;
    font-weight: 700;
  }
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:25px;
    margin-bottom:25px;
    box-shadow:0 4px 20px rgba(0,0,0,0.06);
    border:1px solid var(--border);
  }
  .title{
    font-weight:700;
    font-size:18px;
    margin-bottom:20px;
    color:var(--text-primary);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .title::before{
    content:'';
    display:inline-block;
    width:5px;
    height:22px;
    background:var(--accent);
    border-radius:3px;
  }
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}
  label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase}
  input[type=text],input[type=time],input[type=date],input[type=tel],select,textarea{
    width:100%;
    padding:12px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    font-size:15px;
    background:#fff;
    transition:border-color 0.2s, box-shadow 0.2s;
    line-height: 1.5;
  }
  input:focus,textarea:focus{
    border-color:var(--accent);
    outline:none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  input:valid, textarea:valid {
    border-color: var(--success);
  }
  input:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
    border-color: var(--nok);
  }
  .validation-message {
    color: var(--nok);
    font-size: 12px;
    margin-top: 5px;
    display: none;
  }
  .validation-message.show {
    display: block;
  }
  textarea{min-height:80px;resize:vertical}
  .small{font-size:13px;color:var(--text-secondary)}

  /* Estilos de Tabela */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    font-size:14px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    overflow:hidden;
  }
  th,td{
    padding:12px 10px;
    text-align:left;
    border:none;
    line-height: 1.5;
  }
  th{
    background:#f1f5f9;
    font-weight:700;
    text-align:center;
    border-bottom:2px solid var(--border);
    color:var(--text-primary);
  }
  td{border-bottom:1px solid var(--border)}
  tr:last-child td{border-bottom:none}
  td.center{ text-align:center }

  /* Estilos de Seleﾃｧﾃ｣o (Sim/Nﾃ｣o/N/A) */
  .selectable{
    cursor:pointer;
    user-select:none;
    text-align:center;
    font-weight:700;
    transition:background 0.2s, transform 0.1s;
    border-radius: 6px;
  }
  .selectable:hover{background:#f1f5f9; transform: scale(1.05);}
  .selectable.sim, .selectable.nao, .selectable.na { color:#fff; }
  .selectable.sim { background:var(--ok); }
  .selectable.nao { background:var(--nok); }
  .selectable.na  { background:var(--na); }

  /* 5S toggle */
  .toggle { display:flex; gap:10px; }
  .toggle button {
    flex:1;
    padding:12px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    font-weight:600;
    transition:all 0.2s;
  }
  .toggle button:hover{background:#f1f5f9}
  .toggle button.active {
    background:var(--ok);
    color:#fff;
    border-color:var(--ok);
    box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
  }

  /* Foto */
  .photo-box{
    border:2px dashed var(--border);
    padding:25px;
    border-radius:var(--radius);
    text-align:center;
    background:#fff;
  }
  .photo-preview-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  .photo-preview-item {
    position: relative;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .preview-img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    display: block;
  }
  .remove-photo {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 38, 38, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .remove-photo:hover {
    background: var(--nok);
  }

  /* Botﾃｵes de Aﾃｧﾃ｣o */
  .action-buttons {
    display: flex;
    gap: 15px;
    max-width:1100px;
    margin: 0 auto;
  }
  .action-buttons button {
    flex: 1;
    display:block;
    padding:18px;
    color:#fff;
    border:none;
    border-radius:var(--radius);
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    box-shadow:0 4px 20px rgba(0,0,0,0.15);
    transition:background 0.2s, transform 0.1s;
  }
  .btn-pdf{background:var(--accent);}
  .btn-pdf:hover{background:#1d4ed8; transform: translateY(-2px);}
  .btn-whatsapp{background:#25D366;}
  .btn-whatsapp:hover{background:#128C7E; transform: translateY(-2px);}
  .action-buttons button:disabled{background:var(--na);cursor:not-allowed;box-shadow:none; transform: none;}

  /* Toast de notificaﾃｧﾃ｣o */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 15px 20px;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
    z-index: 1000;
  }
  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }
  .toast.error {
    background: var(--nok);
  }
  .toast.warning {
    background: var(--warning);
  }

  /* Otimizaﾃｧﾃ｣o para PDF/Impressﾃ｣o */
  @media print {
    body{background:#fff;padding:15px;font-size:11pt; line-height: 1.4;}
    .container{max-width:100%;margin:0}
    .card{box-shadow:none;border:1px solid #ccc;padding:15px;margin-bottom:15px;page-break-inside:avoid}
    h1{border-bottom:2px solid #000;color:#000; font-size: 20pt;}
    .title::before{content:none}
    .grid-2{gap:15px}
    input, textarea, select{border:none;border-bottom:1px dashed #000;padding:4px 0;border-radius:0;background:none; line-height: 1.4;}
    label{color:#000;font-size:10pt}
    .btn-pdf, .btn-whatsapp, .toggle, .photo-box input[type=file], .remove-photo{display:none}
    .photo-box{border:none;padding:0;text-align:left}
    .photo-preview-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .photo-preview-item { width: calc(50% - 5px); margin-bottom: 10px; }
    .preview-img{max-width:100%;height:auto;margin-top:0}
    table{border:1px solid #000;font-size:10pt}
    th, td{border:1px solid #000;padding:6px; line-height: 1.3;}
    th{background:#eee !important; color: #000 !important;}
    .selectable.sim, .selectable.nao, .selectable.na { color:#000 !important; background:none !important; }
    .selectable.sim::after{content:' (Sim)'; font-weight: normal;}
    .selectable.nao::after{content:' (Nﾃ｣o)'; font-weight: normal;}
    .selectable.na::after{content:' (N/A)'; font-weight: normal;}
    .selectable{cursor:default; user-select:text; text-align:left; font-weight:normal;}
    .selectable:hover{background:none}
    .selectable[data-print-value]::after { content: attr(data-print-value); display: block; font-weight: bold; color: #000; }
  }

  /* Responsividade */
  @media (max-width:800px){ 
    .grid-2{grid-template-columns:1fr} 
    .action-buttons { flex-direction: column; } 
    .photo-preview-container { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  }
</style>
</head>
<body>
  <div class="container" id="content">
    <h1>CHECKLIST DE VEﾃ垢ULO - EXPEDIﾃﾃグ</h1>

    <!-- SEﾃﾃグ 1: CONTEﾃ咼O PRINCIPAL -->
    <div id="main-content">
      <!-- DADOS GERAIS -->
      <div class="card">
        <div class="title">Dados Gerais</div>
        <div class="grid-2">
          <div>
            <label for="data">Data</label>
            <input type="date" id="data" required />
            <div class="validation-message" id="data-error">Por favor, preencha a data.</div>
          </div>
          <div>
            <label for="transportadora">Transportadora</label>
            <input type="text" id="transportadora" placeholder="Digite a transportadora" required />
            <div class="validation-message" id="transportadora-error">Por favor, preencha a transportadora.</div>
          </div>
          <div>
            <label for="tipoVeiculo">Tipo Veﾃｭculo</label>
            <input type="text" id="tipoVeiculo" placeholder="Ex: Bitrem" required />
            <div class="validation-message" id="tipoVeiculo-error">Por favor, preencha o tipo de veﾃｭculo.</div>
          </div>
          <div>
            <label for="placa">Placa(s)</label>
            <input type="text" id="placa" placeholder="Ex: ABC1D23, XYZ4F56" required />
            <div class="validation-message" id="placa-error">Por favor, preencha a(s) placa(s).</div>
          </div>
          <div>
            <label for="numeroLacre">Nﾃｺmero de Lacre</label>
            <input type="text" id="numeroLacre" placeholder="Digite o nﾃｺmero do lacre" required />
            <div class="validation-message" id="numeroLacre-error">Por favor, preencha o nﾃｺmero do lacre.</div>
          </div>
          <div>
            <label for="horaChegada">Hora de Chegada</label>
            <input type="time" id="horaChegada" required />
            <div class="validation-message" id="horaChegada-error">Por favor, preencha a hora de chegada.</div>
          </div>
          <div>
            <label for="horaInicio">Hora que encostou na Doca</label>
            <input type="time" id="horaInicio" required />
            <div class="validation-message" id="horaInicio-error">Por favor, preencha a hora que encostou na doca.</div>
          </div>
          <div>
            <label for="doca">Doca</label>
            <input type="text" id="doca" required />
            <div class="validation-message" id="doca-error">Por favor, preencha a doca.</div>
          </div>
          <div>
            <label for="agrupamento">Agrupamento</label>
            <input type="text" id="agrupamento" required />
            <div class="validation-message" id="agrupamento-error">Por favor, preencha o agrupamento.</div>
          </div>
          <div>
            <label>5S</label>
            <div class="toggle" id="toggle5s" role="radiogroup" aria-required="true">
              <button type="button" data-value="Sim" aria-checked="false">Sim</button>
              <button type="button" data-value="Nﾃ｣o" aria-checked="false">Nﾃ｣o</button>
            </div>
            <input type="hidden" id="val5s" value="" required />
            <div class="validation-message" id="5s-error">Por favor, selecione uma opﾃｧﾃ｣o para 5S.</div>
          </div>
          <div>
            <label for="obs5s">Observaﾃｧﾃ｣o 5S</label>
            <textarea id="obs5s" placeholder="Observaﾃｧﾃ｣o sobre o 5S"></textarea>
          </div>
          <div>
            <label for="whatsappNumber">WhatsApp de Contato</label>
            <input type="tel" id="whatsappNumber" placeholder="Apenas nﾃｺmeros (ex: 5511912345678)" pattern="[0-9]{10,15}" required />
            <div class="validation-message" id="whatsapp-error">Por favor, preencha um nﾃｺmero de WhatsApp vﾃ｡lido.</div>
          </div>
        </div>
      </div>

      <!-- VALIDAﾃﾃグ DA PORTARIA -->
      <div class="card">
        <div class="title">Validaﾃｧﾃ｣o da Expediﾃｧﾃ｣o</div>
        <table id="tblPortaria" aria-label="Validaﾃｧﾃ｣o da Expediﾃｧﾃ｣o">
          <thead><tr><th>Item</th><th>Descriﾃｧﾃ｣o</th><th class="center">Sim</th><th class="center">Nﾃ｣o</th><th class="center">N/A</th></tr></thead>
          <tbody>
            <tr><td>1</td><td>A carreta estﾃ｡ vazia?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>2</td><td>Possui madeirite?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>3</td><td>Possui corda?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>4</td><td>Possui rede?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
          </tbody>
        </table>
        <div class="validation-message" id="portaria-error">Por favor, preencha todos os itens da validaﾃｧﾃ｣o da expediﾃｧﾃ｣o.</div>
      </div>

      <!-- VALIDAﾃﾃグ DA EXPEDIﾃﾃグ -->
      <div class="card">
        <div class="title">Validaﾃｧﾃ｣o do Conferente</div>
        <table id="tblExped" aria-label="Validaﾃｧﾃ｣o do Conferente">
          <thead><tr><th>Item</th><th>Descriﾃｧﾃ｣o</th><th class="center">Sim</th><th class="center">Nﾃ｣o</th><th class="center">N/A</th></tr></thead>
          <tbody>
            <tr><td>1</td><td>Chave do veﾃｭculo estﾃ｡ no claviculﾃ｡rio?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>2</td><td>Veﾃｭculo com calﾃｧo travando as rodas?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>3</td><td>Sider com 03 rﾃｩguas por coluna?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>4</td><td>Conferente da transportadora acompanhando?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>5</td><td>Conferente conferiu a carga?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>6</td><td>Estﾃ｡ limpo?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>7</td><td>Livre de mau odor?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>8</td><td>Em bom estado?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>9</td><td>Sem vazamento?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>10</td><td>Porta da doca travada?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
            <tr><td>11</td><td>Doca com iluminaﾃｧﾃ｣o correta?</td><td class="selectable" role="button" tabindex="0" aria-label="Sim"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o"></td><td class="selectable" role="button" tabindex="0" aria-label="Nﾃ｣o se aplica"></td></tr>
          </tbody>
        </table>
        <div class="validation-message" id="expedicao-error">Por favor, preencha todos os itens da validaﾃｧﾃ｣o do conferente.</div>
      </div>

      <!-- OBSERVAﾃﾃ髭S / MANUTENﾃﾃグ -->
      <div class="card">
        <div class="title">Observaﾃｧﾃｵes / Manutenﾃｧﾃ｣o</div>
        <textarea id="observacoes" placeholder="Escreva observaﾃｧﾃｵes ou manutenﾃｧﾃ｣o necessﾃ｡ria..."></textarea>
      </div>
    </div>

    <!-- SEﾃﾃグ 2: ASSINATURAS -->
    <div id="signature-content">
      <div class="card">
        <div class="title">Assinaturas</div>
        <div class="grid-2">
          <div>
            <label for="assinMotorista">Assinatura Motorista:</label>
            <input type="text" id="assinMotorista" placeholder="Nome / assinatura (texto)" required />
            <div class="validation-message" id="assinMotorista-error">Por favor, preencha a assinatura do motorista.</div>
          </div>
          <div>
            <label for="assinConferente">Assinatura Conferente:</label>
            <input type="text" id="assinConferente" placeholder="Nome / assinatura (texto)" required />
            <div class="validation-message" id="assinConferente-error">Por favor, preencha a assinatura do conferente.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEﾃﾃグ 3: FOTOS -->
    <div id="photo-content">
      <div class="card">
        <div class="title">foto documento</div>
        <div class="photo-box">
          <input type="file" id="photoInput" accept="image/*" multiple />
          <div id="photoName" class="small" style="margin-top:8px">Nenhum documento selecionado</div>
          <div id="photoPreviewContainer" class="photo-preview-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- botﾃｵes de aﾃｧﾃ｣o -->
  <div class="action-buttons">
    <button class="btn-pdf" id="btnPdf">塘 Gerar PDF</button>
    <button class="btn-whatsapp" id="btnWhatsapp">豆 Enviar via WhatsApp</button>
  </div>

  <!-- Toast de notificaﾃｧﾃ｣o -->
  <div class="toast" id="toast"></div>

  <!-- dependﾃｪncias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- scripts: toggles, seleﾃｧﾃ｣o de tabela, foto e gerar PDF -->
  <script>
  // Array global para armazenar as fotos em Base64
  let photosData = [];

  /******************* 5S Toggle *******************/
  (function(){
    const toggle = document.getElementById('toggle5s');
    if(toggle){
      const buttons = Array.from(toggle.querySelectorAll('button'));
      const inputHidden = document.getElementById('val5s');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          inputHidden.value = btn.dataset.value;
          buttons.forEach(b=>b.setAttribute('aria-checked', 'false'));
          btn.setAttribute('aria-checked', 'true');
        });
        btn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); } });
      });
    }
  })();

  /*********************************************** Funﾃｧﾃ｣o de Seleﾃｧﾃ｣o de Tabela ***********************************************/
  function enableTableSelection(tableId){
    const table = document.getElementById(tableId); 
    if(!table) {
      console.warn(`Tabela com ID "${tableId}" nﾃ｣o encontrada.`);
      return;
    }
    const rows = Array.from(table.tBodies[0].rows);
    rows.forEach(row=>{
      const simCell = row.cells[2]; const naoCell = row.cells[3]; const naCell = row.cells[4];
      [simCell, naoCell, naCell].forEach(cell=>{
        cell.classList.add('selectable'); cell.tabIndex = 0; cell.setAttribute('role','button');
        
        // Usar 'function' para que 'this' se refira ao elemento 'cell' clicado
        cell.addEventListener('click', function() {
          // Limpa outras cﾃｩlulas na linha
          [simCell, naoCell, naCell].forEach(c=>{ c.textContent = ''; c.classList.remove('sim','nao','na'); });
          
          // Marca a cﾃｩlula clicada
          this.textContent = 'X';
          if(this === simCell) this.classList.add('sim');
          if(this === naoCell) this.classList.add('nao');
          if(this === naCell)  this.classList.add('na');
        });
        
        cell.addEventListener('keydown', function(e){ 
          if(e.key === 'Enter' || e.key === ' '){ 
            e.preventDefault(); 
            this.click(); 
          } 
        });
      });
    });
  }
  enableTableSelection('tblPortaria'); 
  enableTableSelection('tblExped');

  /***************** Funﾃｧﾃ｣o para Redimensionar e Converter para Base64 *****************/
  function resizeImage(file, maxWidth, maxHeight) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
          else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
          resolve(resizedBase64);
        };
        img.onerror = () => reject(new Error(`Falha ao carregar a imagem: ${file.name}`));
        img.src = event.target.result;
      };
      reader.onerror = () => reject(new Error(`Falha ao ler o arquivo: ${file.name}`));
      reader.readAsDataURL(file);
    });
  }

  /***************** Foto preview *****************/
  const photoInput = document.getElementById('photoInput');
  const photoName = document.getElementById('photoName');
  const photoPreviewContainer = document.getElementById('photoPreviewContainer');

  photoInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) { photoName.textContent = 'Nenhum documento selecionado'; return; }
    photoName.textContent = `Processando ${files.length} documento(s)...`;
    for (const file of files) {
      try {
        const resizedBase64 = await resizeImage(file, 1024, 1024);
        photosData.push(resizedBase64);
        addPhotoPreview(resizedBase64);
      } catch (error) {
        console.error("Erro ao processar a imagem:", file.name, error);
        showToast(`Erro ao processar a imagem: ${file.name}`, 'error');
      }
    }
    photoName.textContent = `${photosData.length} documento(s) selecionado(s)`;
    saveFormData();
  });

  function addPhotoPreview(base64) {
    const item = document.createElement('div');
    item.className = 'photo-preview-item';
    // A funﾃｧﾃ｣o removePhoto ﾃｩ chamada via onclick, entﾃ｣o precisa estar no escopo global
    item.innerHTML = `<img src="${base64}" alt="Preview do documento" class="preview-img"><button class="remove-photo" onclick="removePhoto(this, '${base64}')">&times;</button>`;
    photoPreviewContainer.appendChild(item);
  }

  // CORREﾃﾃグ: Anexar a funﾃｧﾃ｣o ao objeto window para garantir que seja encontrada pelo onclick
  window.removePhoto = function(button, base64ToRemove) {
    const item = button.parentElement; 
    item.remove();
    photosData = photosData.filter(photo => photo !== base64ToRemove);
    const count = photosData.length;
    photoName.textContent = count > 0 ? `${count} documento(s) selecionado(s)` : 'Nenhum documento selecionado';
    saveFormData();
  }

  /***************** Validaﾃｧﾃ｣o de Formulﾃ｡rio *****************/
  function validateForm() {
    let isValid = true;
    const requiredFields = ['data', 'transportadora', 'tipoVeiculo', 'placa', 'numeroLacre', 'horaChegada', 'horaInicio', 'doca', 'agrupamento', 'whatsappNumber', 'assinMotorista', 'assinConferente'];
    requiredFields.forEach(fieldId => {
      const field = document.getElementById(fieldId); 
      const errorMsg = document.getElementById(`${fieldId}-error`);
      if (!field || !errorMsg) return; // Pula se o campo nﾃ｣o existir

      if (!field.value.trim()) { 
        errorMsg.classList.add('show'); 
        isValid = false; 
      } else { 
        errorMsg.classList.remove('show'); 
      }
    });
    const val5s = document.getElementById('val5s'); 
    const error5s = document.getElementById('5s-error');
    if (!val5s.value) { 
      error5s.classList.add('show'); 
      isValid = false; 
    } else { 
      error5s.classList.remove('show'); 
    }
    const tables = ['tblPortaria', 'tblExped'];
    tables.forEach(tableId => {
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = Array.from(table.tBodies[0].rows); 
      let allSelected = true;
      rows.forEach(row => { 
        if (!row.querySelector('.selectable.sim, .selectable.nao, .selectable.na')) { 
          allSelected = false; 
        } 
      });
      const errorMsgId = tableId === 'tblPortaria' ? 'portaria-error' : 'expedicao-error';
      const errorMsg = document.getElementById(errorMsgId);
      if (!allSelected) { 
        errorMsg.classList.add('show'); 
        isValid = false; 
      } else { 
        errorMsg.classList.remove('show'); 
      }
    });
    return isValid;
  }

  /***************** Toast de Notificaﾃｧﾃ｣o *****************/
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast'); 
    toast.textContent = message; 
    toast.className = 'toast show';
    if (type === 'error') toast.classList.add('error'); 
    else if (type === 'warning') toast.classList.add('warning');
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
  }

  /***************** Salvar Dados Localmente *****************/
  function saveFormData() {
    // CORREﾃﾃグ: Adicionar verificaﾃｧﾃ｣o para o localStorage
    if (typeof Storage === "undefined") {
      console.warn("LocalStorage nﾃ｣o disponﾃｭvel. Dados nﾃ｣o serﾃ｣o salvos.");
      return;
    }
    try {
      const formData = { 
        data: document.getElementById('data').value, 
        transportadora: document.getElementById('transportadora').value, 
        tipoVeiculo: document.getElementById('tipoVeiculo').value, 
        placa: document.getElementById('placa').value, 
        numeroLacre: document.getElementById('numeroLacre').value, 
        horaChegada: document.getElementById('horaChegada').value, 
        horaInicio: document.getElementById('horaInicio').value, 
        doca: document.getElementById('doca').value, 
        agrupamento: document.getElementById('agrupamento').value, 
        val5s: document.getElementById('val5s').value, 
        obs5s: document.getElementById('obs5s').value, 
        whatsappNumber: document.getElementById('whatsappNumber').value, 
        observacoes: document.getElementById('observacoes').value, 
        assinMotorista: document.getElementById('assinMotorista').value, 
        assinConferente: document.getElementById('assinConferente').value, 
        portaria: getTableData('tblPortaria'), 
        expedicao: getTableData('tblExped'), 
        photos: photosData 
      };
      localStorage.setItem('checklistData', JSON.stringify(formData));
    } catch (e) {
      console.error("Erro ao salvar dados no localStorage:", e);
    }
  }

  function getTableData(tableId) {
    const table = document.getElementById(tableId); 
    if (!table) return [];
    const rows = Array.from(table.tBodies[0].rows); 
    const data = [];
    rows.forEach(row => {
      const description = row.cells[1].textContent.trim(); 
      let status = 'N/A';
      const selectableCells = row.querySelectorAll('.selectable');
      selectableCells.forEach(cell => { 
        if (cell.textContent.trim() === 'X') { 
          if (cell.classList.contains('sim')) status = 'Sim'; 
          else if (cell.classList.contains('nao')) status = 'Nﾃ｣o'; 
          else if (cell.classList.contains('na')) status = 'N/A'; 
        } 
      });
      data.push({ description, status });
    });
    return data;
  }

  function loadFormData() {
    // CORREﾃﾃグ: Adicionar verificaﾃｧﾃ｣o para o localStorage e validaﾃｧﾃ｣o de dados
    if (typeof Storage === "undefined") {
      console.warn("LocalStorage nﾃ｣o disponﾃｭvel. Dados nﾃ｣o serﾃ｣o carregados.");
      return;
    }
    try {
      const savedData = localStorage.getItem('checklistData'); 
      if (!savedData) return;
      
      const formData = JSON.parse(savedData);
      if (!formData || typeof formData !== 'object') {
        console.warn("Dados salvos sﾃ｣o invﾃ｡lidos. Limpando o storage.");
        localStorage.removeItem('checklistData');
        return;
      }

      document.getElementById('data').value = formData.data || ''; 
      document.getElementById('transportadora').value = formData.transportadora || ''; 
      document.getElementById('tipoVeiculo').value = formData.tipoVeiculo || ''; 
      document.getElementById('placa').value = formData.placa || ''; 
      document.getElementById('numeroLacre').value = formData.numeroLacre || ''; 
      document.getElementById('horaChegada').value = formData.horaChegada || ''; 
      document.getElementById('horaInicio').value = formData.horaInicio || ''; 
      document.getElementById('doca').value = formData.doca || ''; 
      document.getElementById('agrupamento').value = formData.agrupamento || ''; 
      document.getElementById('obs5s').value = formData.obs5s || ''; 
      document.getElementById('whatsappNumber').value = formData.whatsappNumber || ''; 
      document.getElementById('observacoes').value = formData.observacoes || ''; 
      document.getElementById('assinMotorista').value = formData.assinMotorista || ''; 
      document.getElementById('assinConferente').value = formData.assinConferente || '';
      
      if (formData.val5s) { 
        const buttons = document.querySelectorAll('#toggle5s button'); 
        buttons.forEach(btn => { 
          if (btn.dataset.value === formData.val5s) btn.click(); 
        }); 
      }
      if (formData.portaria) fillTableData('tblPortaria', formData.portaria);
      if (formData.expedicao) fillTableData('tblExped', formData.expedicao);
      if (formData.photos && formData.photos.length > 0) { 
        photosData = formData.photos; 
        photoName.textContent = `${photosData.length} documento(s) selecionado(s)`; 
        photoPreviewContainer.innerHTML = ''; 
        photosData.forEach(base64 => { 
          addPhotoPreview(base64); 
        }); 
      }
      showToast('Dados recuperados com sucesso!');
    } catch (e) { 
      console.error('Erro ao carregar dados:', e); 
      showToast('Erro ao carregar dados salvos', 'error'); 
    }
  }

  function fillTableData(tableId, data) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = Array.from(table.tBodies[0].rows);
    rows.forEach((row, index) => {
      if (data[index]) {
        const status = data[index].status; 
        const selectableCells = row.querySelectorAll('.selectable');
        selectableCells.forEach(cell => { 
          cell.textContent = ''; 
          cell.classList.remove('sim', 'nao', 'na'); 
        });
        if (status === 'Sim') { 
          row.cells[2].textContent = 'X'; 
          row.cells[2].classList.add('sim'); 
        }
        else if (status === 'Nﾃ｣o') { 
          row.cells[3].textContent = 'X'; 
          row.cells[3].classList.add('nao'); 
        }
        else if (status === 'N/A') { 
          row.cells[4].textContent = 'X'; 
          row.cells[4].classList.add('na'); 
        }
      }
    });
  }

  // Carregar dados ao iniciar a pﾃ｡gina
  window.addEventListener('DOMContentLoaded', () => {
    loadFormData();
    document.querySelectorAll('input, textarea').forEach(element => { 
      element.addEventListener('change', saveFormData); 
    });
    document.querySelectorAll('.selectable').forEach(cell => { 
      cell.addEventListener('click', () => { setTimeout(saveFormData, 100); }); 
    });
  });

  /***************** Gerar PDF - ORDEM DAS Pﾃ；INAS ALTERADA *****************/
  document.getElementById('btnPdf').addEventListener('click', async (e)=>{ 
    e.preventDefault(); 
    if (!validateForm()) { 
      showToast('Por favor, preencha todos os campos obrigatﾃｳrios', 'error'); 
      return; 
    } 
    await generatePdf(); 
  });

  async function generatePdf() {
    const btn = document.getElementById('btnPdf'); 
    const originalText = btn.innerText; 
    btn.disabled = true; 
    btn.innerText = 'Gerando PDF...';
    try {
      // CORREﾃﾃグ: Verificaﾃｧﾃ｣o mais robusta e inicializaﾃｧﾃ｣o do jsPDF
      if (typeof html2canvas === 'undefined') {
        throw new Error("Biblioteca html2canvas nﾃ｣o carregada. Verifique sua conexﾃ｣o com a internet.");
      }
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        throw new Error("Biblioteca jsPDF nﾃ｣o carregada. Verifique sua conexﾃ｣o com a internet.");
      }
      
      // CORREﾃﾃグ: Inicializaﾃｧﾃ｣o do jsPDF de forma mais robusta
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      // --- Funﾃｧﾃ｣o auxiliar para capturar e adicionar uma seﾃｧﾃ｣o ao PDF ---
      const addSectionToPdf = async (elementId) => {
        const element = document.getElementById(elementId); 
        if (!element) {
          console.warn(`Elemento com ID "${elementId}" nﾃ｣o encontrado para o PDF.`);
          return;
        }
        const canvas = await html2canvas(element, { 
          scale: 2, 
          useCORS: true, 
          allowTaint: false, 
          logging: false, 
          backgroundColor: '#ffffff',
            onclone: (clonedDoc) => {
                if (elementId === 'photo-content') {
                    const clonedContainer = clonedDoc.getElementById('photoPreviewContainer');
                    if (clonedContainer && photosData.length > 0) {
                        clonedContainer.innerHTML = '';
                        photosData.forEach(base64 => {
                            const item = clonedDoc.createElement('div');
                            item.className = 'photo-preview-item';
                            item.innerHTML = `<img src="${base64}" alt="Foto do Documento" class="preview-img">`;
                            clonedContainer.appendChild(item);
                        });
                    }
                }
            }
        });
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = canvas.width; 
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const imgX = (pdfWidth - imgWidth * ratio) / 2;
        const imgY = 0;
        pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
      };

      // Prepara o DOM para a impressﾃ｣o
      document.querySelectorAll('input[type="text"], input[type="time"], input[type="date"], textarea').forEach(input => { 
        input.setAttribute('value', input.value); 
      });
      document.querySelectorAll('.selectable').forEach(cell => {
        if (cell.textContent === 'X') {
          const text = cell.classList.contains('sim') ? 'Sim' : cell.classList.contains('nao') ? 'Nﾃ｣o' : cell.classList.contains('na') ? 'N/A' : '';
          cell.setAttribute('data-print-value', text);
        } else { 
          cell.removeAttribute('data-print-value'); 
        }
      });

      // Pﾃ｡gina 1: Conteﾃｺdo Principal
      await addSectionToPdf('main-content');
      
      // Pﾃ｡gina 2: Assinaturas
      pdf.addPage();
      await addSectionToPdf('signature-content');
      
      // Pﾃ｡gina 3: Fotos (se existirem)
      if (photosData.length > 0) {
        pdf.addPage();
        await addSectionToPdf('photo-content');
      }
      
      const nomeArquivo = `Checklist_Expedicao_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "_")}.pdf`;
      pdf.save(nomeArquivo);
      showToast('PDF gerado com sucesso!');
    } catch (error) {
      console.error("ERRO DETALHADO AO GERAR PDF:", error);
      showToast(`Ocorreu um erro ao gerar o PDF: ${error.message}`, 'error');
    } finally { 
      btn.disabled = false; 
      btn.innerText = originalText; 
    }
  }

  /***************** Enviar via WhatsApp *****************/
  document.getElementById('btnWhatsapp').addEventListener('click', () => { 
    if (!validateForm()) { 
      showToast('Por favor, preencha todos os campos obrigatﾃｳrios', 'error'); 
      return; 
    } 
    shareViaWhatsApp(); 
  });
  function shareViaWhatsApp() {
    const phoneInput = document.getElementById('whatsappNumber'); 
    const phoneNumber = phoneInput.value.replace(/\D/g, '');
    if (!phoneNumber) { 
      showToast('Por favor, preencha o campo "WhatsApp de Contato" com o nﾃｺmero de telefone (apenas nﾃｺmeros).', 'error'); 
      phoneInput.focus(); 
      return; 
    } 
    const message = formatMessageForWhatsApp(); 
    const encodedMessage = encodeURIComponent(message); 
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`; 
    window.open(whatsappUrl, '_blank'); 
    showToast('Mensagem enviada via WhatsApp!');
  }
  function formatMessageForWhatsApp() {
    let message = `*CHECKLIST DE VEﾃ垢ULO - EXPEDIﾃﾃグ*\n\n`; 
    message += `--- *DADOS GERAIS* ---\n`; 
    message += `Data: ${document.getElementById('data').value || 'N/A'}\n`; 
    message += `Transportadora: ${document.getElementById('transportadora').value || 'N/A'}\n`; 
    message += `Tipo Veﾃｭculo: ${document.getElementById('tipoVeiculo').value || 'N/A'}\n`; 
    message += `Placa(s): ${document.getElementById('placa').value || 'N/A'}\n`; 
    message += `Nﾃｺmero de Lacre: ${document.getElementById('numeroLacre').value || 'N/A'}\n`; 
    message += `Hora Chegada: ${document.getElementById('horaChegada').value || 'N/A'}\n`; 
    message += `Hora na Doca: ${document.getElementById('horaInicio').value || 'N/A'}\n`; 
    message += `Doca: ${document.getElementById('doca').value || 'N/A'}\n`; 
    message += `Agrupamento: ${document.getElementById('agrupamento').value || 'N/A'}\n`; 
    message += `5S: ${document.getElementById('val5s').value || 'N/A'}\n`; 
    message += `Obs. 5S: ${document.getElementById('obs5s').value || 'N/A'}\n\n`;
    message += `--- *VALIDAﾃﾃグ DA EXPEDIﾃﾃグ* ---\n`; 
    message += getTableDataForWhatsApp('tblPortaria');
    message += `--- *VALIDAﾃﾃグ DO CONFERENTE* ---\n`; 
    message += getTableDataForWhatsApp('tblExped');
    message += `--- *OBSERVAﾃﾃ髭S / MANUTENﾃﾃグ* ---\n`; 
    message += `${document.getElementById('observacoes').value || 'Nenhuma'}\n\n`;
    message += `--- *ASSINATURAS* ---\n`; 
    message += `Motorista: ${document.getElementById('assinMotorista').value || 'N/A'}\n`; 
    message += `Conferente: ${document.getElementById('assinConferente').value || 'N/A'}\n`;
    if (photosData.length > 0) { 
      message += `\n--- *DOCUMENTOS* ---\n`; 
      message += `Este checklist inclui ${photosData.length} documento(s) anexado(s) no PDF gerado.`; 
    }
    return message;
  }
  function getTableDataForWhatsApp(tableId) {
    const table = document.getElementById(tableId); 
    if (!table) return `Erro: Tabela com ID "${tableId}" nﾃ｣o encontrada.\n\n`;
    let tableText = ''; 
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const descriptionCell = row.cells[1]; 
      const description = descriptionCell ? descriptionCell.textContent.trim() : 'Descriﾃｧﾃ｣o nﾃ｣o encontrada';
      let status = 'N/A'; 
      const selectableCells = row.querySelectorAll('.selectable');
      selectableCells.forEach(cell => { 
        if (cell.textContent.trim() === 'X') { 
          if (cell.classList.contains('sim')) status = 'Sim'; 
          else if (cell.classList.contains('nao')) status = 'Nﾃ｣o'; 
          else if (cell.classList.contains('na')) status = 'N/A'; 
        } 
      });
      tableText += `- ${description}: *${status}*\n`;
    });
    return tableText + '\n';
  }
  </script>
</body>
</html>